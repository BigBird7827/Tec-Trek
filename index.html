<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tec-Trek • Science & Technology</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg0:#0b0f16;
      --bg1:#0f1622;
      --text:#e7eefc;
      --muted:#a9b7d4;
      --gold:#B29433;
      --teal:#76a5af;
      --shadow:0 14px 35px rgba(0,0,0,.45);
      --r18:18px;
      --r22:22px;
    }
    

    .section h2, .section h3, .section h4{
      color: var(--gold);
    }
    .card h3{
      color: var(--gold);
    }

    h1, .title, .pageTitle{
      font-size: 72pt;
    }

*{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 25% 10%, rgba(118,165,175,.18), transparent 55%),
        radial-gradient(900px 600px at 80% 20%, rgba(178,148,51,.16), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      font-family:Roboto, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
    }
    a{ color:inherit; text-decoration:none; }
    button, input{ font-family:inherit; }
    .wrap{ max-width:1400px; margin:0 auto; padding:18px 18px 28px; }

    .topbar{
      position:sticky; top:0; z-index:60;
      padding:14px 0 12px;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(11,15,22,.86), rgba(11,15,22,.55));
      border-bottom:1px solid rgba(178,148,51,.22);
    }
    .titleRow{ display:flex; align-items:flex-start; justify-content:space-between; gap:16px; }
    .brand h1{
      margin:0;
      font-family:Orbitron, sans-serif;
      font-weight:800;
      letter-spacing:.12em;
      font-size:32pt;
      line-height:1.1;
      background: linear-gradient(180deg, #f6e3a8, #caa23f 55%, #8a6e1f);
      -webkit-background-clip: text; background-clip: text; color: transparent;
      text-shadow: 0 1px 0 rgba(0,0,0,.6);
    }
    .brand .sub{ margin-top:6px; font-size:13px; color:var(--muted); letter-spacing:.03em; }

    .badgeRow{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; margin-top:2px; }
    .badge{
      display:flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      background: linear-gradient(180deg, rgba(18,27,42,.9), rgba(12,18,30,.9));
      border:1px solid rgba(178,148,51,.35);
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
      font-size:12px; color:var(--muted); white-space:nowrap;
    }
    .badge b{ color:var(--text); font-weight:700; }

    .controls{
      margin-top:12px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .crumbs{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      flex: 1 1 320px;
    }
    .crumb{
      cursor:pointer;
      border:none;
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      background: linear-gradient(180deg, rgba(18,27,42,.92), rgba(12,18,30,.92));
      border:1px solid rgba(178,148,51,.22);
      box-shadow: 0 10px 20px rgba(0,0,0,.2);
      transition: transform .08s ease, border-color .2s ease, color .2s ease;
    }
    .crumb:hover{ transform: translateY(-1px); border-color: rgba(178,148,51,.46); color: var(--text); }
    .crumb.active{
      color:#0b0f16;
      background: linear-gradient(180deg, #f7e8b6, #caa23f 60%, #8a6e1f);
      border-color: rgba(0,0,0,.35);
    }
    .searchBox{
      flex: 1 1 340px; display:flex; gap:10px; align-items:center;
      padding:10px 12px; border-radius:999px;
      background: linear-gradient(180deg, rgba(18,27,42,.92), rgba(12,18,30,.92));
      border:1px solid rgba(178,148,51,.32);
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
    }
    .searchBox input{ width:100%; border:none; outline:none; background:transparent; color:var(--text); font-size:14px; }
    .chipBtn{
      border:none; cursor:pointer; padding:10px 14px; border-radius:999px;
      font-size:12px; font-weight:800; letter-spacing:.06em; text-transform:uppercase;
      background: linear-gradient(180deg, rgba(18,27,42,.92), rgba(12,18,30,.92));
      border:2px solid rgba(178,148,51,.32);
      color: rgba(246,227,168,.95);
      box-shadow: var(--shadow);
      transition: transform .08s ease, border-color .2s ease;
    }
    .chipBtn:hover{ transform: translateY(-1px); border-color: rgba(178,148,51,.6); }

    .content{ margin-top:14px; display:grid; grid-template-columns: 1fr; gap:14px; }
    .panel{
      border-radius: var(--r22);
      background: linear-gradient(180deg, rgba(18,27,42,.92), rgba(12,18,30,.92));
      border: 2px solid rgba(178,148,51,.35);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHeader{
      padding:14px 16px;
      border-bottom:1px solid rgba(178,148,51,.22);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: linear-gradient(180deg, rgba(27,35,52,.7), rgba(10,15,24,.6));
    }
    .panelHeader h2{
      margin:0;
      font-family: Orbitron, sans-serif;
      font-size:14px;
      letter-spacing:.1em;
      color: rgba(246,227,168,.95);
      text-transform:uppercase;
    }
    .small{ font-size:12px; color:var(--muted); }
    .body{ padding:16px; }

    .grid{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:12px; }
    .card{
      border-radius: 18px;
      padding:14px 14px 12px;
      background: linear-gradient(180deg, rgba(20,30,48,.92), rgba(10,16,28,.92));
      border:2px solid rgba(178,148,51,.28);
      box-shadow: 0 12px 24px rgba(0,0,0,.28);
      cursor:pointer;
      transition: transform .10s ease, border-color .2s ease, box-shadow .2s ease;
    }
    .card:hover{ transform: translateY(-2px); border-color: rgba(178,148,51,.52); box-shadow: 0 18px 36px rgba(0,0,0,.35); }
    .card h3{ margin:0; font-size:15px; font-weight:800; letter-spacing:.02em; }
    .meta{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; font-size:12px; color:var(--muted); }
    .pill{ display:inline-flex; align-items:center; padding:4px 10px; border-radius:999px; border:1px solid rgba(178,148,51,.25); background: rgba(9,13,20,.35); color: var(--muted); font-size:11px; white-space:nowrap; }
    .pill.teal{ border-color: rgba(118,165,175,.35); }
    .desc{ margin-top:10px; font-size:12.8px; color:var(--muted); line-height:1.35; }

    .split{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; align-items:start; }

    .detailTitle{
      margin:0;
      font-family: Orbitron, sans-serif;
      letter-spacing:.07em;
      font-size:22px;
      color: rgba(246,227,168,.95);
    }
    .detailSummary{ margin:10px 0 0; color: var(--text); line-height:1.55; font-size:14px; }
    .section{
      margin-top:12px;
      padding:14px 14px 12px;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(20,30,48,.88), rgba(10,16,28,.88));
      border:1px solid rgba(178,148,51,.22);
    }
    .section h4{
      margin:0;
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: rgba(118,165,175,.95);
      font-family: Orbitron, sans-serif;
    }
    .section p{ margin:10px 0 0; color: var(--text); line-height:1.6; font-size:13.5px; white-space:pre-wrap; }

    .empty{ padding:20px 14px; color: var(--muted); font-size:13px; line-height:1.4; }

    .footer{ margin-top:14px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }
    .btn{
      cursor:pointer;
      border:none;
      padding:12px 16px;
      border-radius:999px;
      font-weight:800;
      letter-spacing:.06em;
      background: linear-gradient(180deg, rgba(18,27,42,.95), rgba(12,18,30,.95));
      border:2px solid rgba(178,148,51,.35);
      color: rgba(246,227,168,.95);
      box-shadow: var(--shadow);
      transition: transform .08s ease, border-color .2s ease;
      text-transform:uppercase;
      font-size:12px;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(178,148,51,.6); }

    .sysHero{ display:grid; grid-template-columns: 1fr 340px; gap:14px; align-items:start; }
    .sysImage{ padding:14px; }
    .sysImage img{ width:100%; height:auto; display:block; border-radius:14px; border:1px solid rgba(178,148,51,.22); box-shadow: 0 12px 24px rgba(0,0,0,.22); }
    .sysImage .cap{ margin-top:10px; font-size:12px; color:var(--muted); line-height:1.4; }

    .miniBtn{
      border:none; cursor:pointer;
      padding:8px 12px;
      border-radius:999px;
      font-size:11px;
      font-weight:800;
      letter-spacing:.08em;
      text-transform:uppercase;
      background: rgba(9,13,20,.35);
      border:1px solid rgba(178,148,51,.25);
      color: rgba(246,227,168,.95);
      margin-top:10px;
    }
    .miniBtn:hover{ border-color: rgba(178,148,51,.55); }
    .miniBtn:disabled{ opacity:.6; cursor:default; }
    .miniBtn:disabled:hover{ border-color: rgba(178,148,51,.25); }
    .imgCard img{ width:100%; height:auto; display:block; border-radius:14px; border:1px solid rgba(178,148,51,.22); box-shadow: 0 12px 24px rgba(0,0,0,.22); }
    .imgCard .cap{ margin-top:10px; font-size:12px; color:var(--muted); line-height:1.4; }

    .chipRow{ display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; }
    .pillLink{ cursor:pointer; }
    .pillLink:hover{ border-color: rgba(178,148,51,.55); color: var(--text); }


    @media (max-width: 1100px){
      .grid{ grid-template-columns: 1fr; }
      .split{ grid-template-columns: 1fr; }
      .sysHero{ grid-template-columns: 1fr; }
    }
  </style>
<style id="mainConsoleNavStyle">
  #mainConsoleLink {
    position: fixed;
    top: 16px;
    left: 16px;
    z-index: 99999;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 10px 14px;
    border-radius: 12px;
    text-decoration: none;
    font-weight: 700;
    letter-spacing: 0.06em;
    font-size: 12px;
    border: 1px solid rgba(255, 255, 255, 0.25);
    background: rgba(20, 25, 35, 0.85);
    color: rgba(255, 255, 255, 0.92);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    box-shadow: 0 8px 18px rgba(0, 0, 0, 0.35);
    transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
  }
  #mainConsoleLink:hover {
    transform: translateY(-1px);
    box-shadow: 0 10px 22px rgba(0, 0, 0, 0.42);
    background: rgba(26, 33, 46, 0.9);
  }
  #mainConsoleLink:active {
    transform: translateY(0px);
    box-shadow: 0 8px 18px rgba(0, 0, 0, 0.35);
  }
</style>
</head>
<body>
  <a id="mainConsoleLink" href="https://bigbird7827.github.io/Main-Console/">MAIN CONSOLE</a>
  <div class="topbar">
    <div class="wrap">
      <div class="titleRow">
        <div class="brand">
          <h1>TEC‑TREK</h1>
          <div class="sub">Science & Technology Database</div>
        </div>
        <div class="badgeRow">
          <div class="badge"><span>Total Tech</span> <b id="totalTech">0</b></div>
          <div class="badge"><span>Systems</span> <b id="totalSystems">0</b></div>
          <div class="badge"><span>View</span> <b id="viewBadge">Systems</b></div>
        </div>
      </div>

      <div class="controls">
        <div class="crumbs" id="crumbs"></div>

        <div class="searchBox" title="Search within the current view">
          <span style="color:var(--muted);font-weight:800;letter-spacing:.08em;">SEARCH</span>
          <input id="searchInput" type="text" placeholder="Search..." />
        </div>

        <button class="chipBtn" id="clearBtn">Clear</button>
        <button class="chipBtn" id="mainBtn" type="button" onclick="window.location.href='https://bigbird7827.github.io/'">Main Console</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="content">
      <section class="panel">
        <div class="panelHeader">
          <h2 id="panelTitle">Systems</h2>
          <div class="small" id="panelNote">Select a system to view technologies</div>
        </div>
        <div class="body" id="panelBody">
          <div class="empty">Loading...</div>
        </div>
      </section>
    </div>

    <div class="footer">
      <button class="btn" id="topBtn">Back to Top</button>
    </div>
  </div>

  <script>
    const DATA_URL = "https://raw.githubusercontent.com/BigBird7827/Tec-Trek/main/Technology.json";
    const state = {
      systems: [],
      tech: [],
      systemsById: new Map(),
      techById: new Map(),
      query: "",
      view: "systems",
      systemId: null,
      techId: null
    };

    const el = (id) => document.getElementById(id);
    const norm = (s) => String(s || "").toLowerCase().trim();

    function qp(){
      const u = new URL(window.location.href);
      return u.searchParams;
    }

    function setRoute(next){
      const u = new URL(window.location.href);
      u.searchParams.set("view", next.view);
      if(next.systemId) u.searchParams.set("system", next.systemId); else u.searchParams.delete("system");
      if(next.techId) u.searchParams.set("tech", next.techId); else u.searchParams.delete("tech");
      window.history.pushState({}, "", u.toString());
      readRoute();
      render();
    }

    function readRoute(){
      const p = qp();
      const v = p.get("view") || "systems";
      const system = p.get("system");
      const tech = p.get("tech");
      state.view = v;
      state.systemId = system;
      state.techId = tech;
      if(state.view === "system" && !state.systemId) state.view = "systems";
      if(state.view === "tech" && !state.techId) state.view = "systems";
    }

    async function loadJson(url){
      const res = await fetch(url, { cache: "no-cache" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      return await res.json();
    }

    async function init(){
      let payload = null;

      try{
        if(DATA_URL) payload = await loadJson(DATA_URL);
      }catch(e){
        payload = null;
      }

      let systems = null;
      let tech = null;

      if(payload && typeof payload === "object"){
        systems = payload.Systems;
        tech = payload.Technologies;
      }

      if(!Array.isArray(systems)) systems = [];
      if(!Array.isArray(tech)) tech = [];
      state.systems = systems.map(s => ({ ID: s.ID, Name: s.Name, Description: s.Description || "", SidebarText: s.SidebarText || "", SortOrder: typeof s.SortOrder === "number" ? s.SortOrder : 9999 }));
      state.tech = tech.map(t => ({ ID: t.ID, Name: t.Name, SystemID: t.SystemID, Type: t.Type || "Entry", Summary: t.Summary || "", Sections: t.Sections || {}, RelatedTechIDs: Array.isArray(t.RelatedTechIDs) ? t.RelatedTechIDs : [], Media: t.Media || {}, Operators: Array.isArray(t.Operators) ? t.Operators : [], Constraints: Array.isArray(t.Constraints) ? t.Constraints : [], KeyTerms: Array.isArray(t.KeyTerms) ? t.KeyTerms : [], Appearances: Array.isArray(t.Appearances) ? t.Appearances : [], Meta: t.Meta || {} }));

      state.systems.sort((a,b) => (a.SortOrder - b.SortOrder) || a.Name.localeCompare(b.Name));

      state.systemsById = new Map(state.systems.map(s => [s.ID, s]));
      state.techById = new Map(state.tech.map(t => [t.ID, t]));

      el("totalTech").textContent = state.tech.length;
      el("totalSystems").textContent = state.systems.length;

      wireUI();
      readRoute();
      render();
    }

    function wireUI(){
      el("searchInput").addEventListener("input", (ev) => { state.query = ev.target.value || ""; render(); });
      el("clearBtn").addEventListener("click", () => { state.query = ""; el("searchInput").value = ""; render(); });
      el("topBtn").addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));
      window.addEventListener("popstate", () => { readRoute(); render(); });
    }

    function buildCrumbs(){
      const wrap = el("crumbs");
      wrap.innerHTML = "";

      const bSystems = document.createElement("button");
      bSystems.className = "crumb" + (state.view === "systems" ? " active" : "");
      bSystems.textContent = "Systems";
      bSystems.addEventListener("click", () => setRoute({ view: "systems" }));
      wrap.appendChild(bSystems);

      if(state.view === "system" || state.view === "tech"){
        const s = state.systemsById.get(state.systemId);
        if(s){
          const bSystem = document.createElement("button");
          bSystem.className = "crumb" + (state.view === "system" ? " active" : "");
          bSystem.textContent = s.Name;
          bSystem.addEventListener("click", () => setRoute({ view: "system", systemId: s.ID }));
          wrap.appendChild(bSystem);
        }
      }

      if(state.view === "tech"){
        const t = state.techById.get(state.techId);
        if(t){
          const bTech = document.createElement("button");
          bTech.className = "crumb active";
          bTech.textContent = t.Name;
          bTech.addEventListener("click", () => setRoute({ view: "tech", systemId: t.SystemID, techId: t.ID }));
          wrap.appendChild(bTech);
        }
      }
    }

    function inViewSearch(itemText){
      const q = norm(state.query);
      if(!q) return true;
      return norm(itemText).includes(q);
    }

    function render(){
      buildCrumbs();

      if(state.view === "systems"){
        el("viewBadge").textContent = "Systems";
        el("panelTitle").textContent = "Systems";
        el("panelNote").textContent = "Select a system to view technologies";
        renderSystems();
        return;
      }

      if(state.view === "system"){
        const s = state.systemsById.get(state.systemId);
        if(!s){ setRoute({ view: "systems" }); return; }
        el("viewBadge").textContent = "System";
        el("panelTitle").textContent = s.Name;
        el("panelNote").textContent = "Select a technology to view details";
        renderSystemTech(s.ID);
        return;
      }

      if(state.view === "tech"){
        const t = state.techById.get(state.techId);
        if(!t){ setRoute({ view: "systems" }); return; }
        el("viewBadge").textContent = "Tech";
        el("panelTitle").textContent = t.Name;
        el("panelNote").textContent = t.Type + " • " + (state.systemsById.get(t.SystemID)?.Name || t.SystemID);
        renderTech(t.ID);
        return;
      }
    }

    function renderSystems(){
      const body = el("panelBody");
      body.innerHTML = "";

      const grid = document.createElement("div");
      grid.className = "grid";

      const techCount = new Map();
      state.tech.forEach(t => techCount.set(t.SystemID, (techCount.get(t.SystemID) || 0) + 1));

      const list = state.systems
        .filter(s => inViewSearch(s.Name + " " + s.Description + " " + (s.SidebarText || "")))
        .map(s => ({ ...s, Count: techCount.get(s.ID) || 0 }))
        .sort((a,b) => a.Name.localeCompare(b.Name));

      if(!list.length){ body.innerHTML = '<div class="empty">No systems match your search.</div>'; return; }

      list.forEach(s => {
        const c = document.createElement("div");
        c.className = "card";
        c.setAttribute("role", "button");
        c.setAttribute("tabindex", "0");

        const h = document.createElement("h3");
        h.textContent = s.Name;

        const meta = document.createElement("div");
        meta.className = "meta";

        const p1 = document.createElement("span");
        p1.className = "pill teal";
        p1.textContent = "System";

        const p2 = document.createElement("span");
        p2.className = "pill";
        p2.textContent = s.Count + " tech";

        meta.appendChild(p1);
        meta.appendChild(p2);

        const d = document.createElement("div");
        d.className = "desc";
        d.textContent = s.Description || "";

        const go = () => setRoute({ view: "system", systemId: s.ID });

        c.addEventListener("click", go);
        c.addEventListener("keydown", (ev) => { if(ev.key === "Enter" || ev.key === " ") go(); });

        c.appendChild(h);
        c.appendChild(meta);
        c.appendChild(d);
        grid.appendChild(c);
      });

      body.appendChild(grid);
    }

    function renderSystemTech(systemId){
      const body = el("panelBody");
      body.innerHTML = "";

      const sys = state.systemsById.get(systemId);

      let setHeroPreview = null;
      let resetHeroPreview = null;

      const split = document.createElement("div");
      split.className = "split";

      const left = document.createElement("div");
      const right = document.createElement("div");

      const sysCard = document.createElement("div");
      sysCard.className = "section";

      const st = document.createElement("h4");
      st.textContent = "System Overview";

      const sp = document.createElement("p");
      sp.textContent = sys.Description || "";

      sysCard.appendChild(st);
      sysCard.appendChild(sp);

      const hero = document.createElement("div");
      hero.className = "sysHero";

      const heroLeft = document.createElement("div");
      heroLeft.appendChild(sysCard);

      const heroRight = document.createElement("div");
      heroRight.className = "section sysImage";

      const imgTech = state.tech
        .filter(t => t.SystemID === systemId && t.Media && t.Media.Image)
        .sort((a,b)=>a.Name.localeCompare(b.Name));

      const fixedSystemImage = systemId === "propulsion" ? "https://raw.githubusercontent.com/BigBird7827/Tec-Trek/main/Images/Enterprise%20NCC-1701.png" : "";

      if(fixedSystemImage || imgTech.length){
        const im = document.createElement("img");
        im.src = fixedSystemImage || imgTech[0].Media.Image;
        im.alt = fixedSystemImage ? "Enterprise NCC-1701" : imgTech[0].Name;

        const cap = document.createElement("div");
        cap.className = "cap";
        cap.textContent = fixedSystemImage ? "Enterprise NCC-1701" : imgTech[0].Name;

        heroRight.appendChild(im);
        heroRight.appendChild(cap);

        const heroDefault = { src: im.src, alt: im.alt, cap: cap.textContent };
        setHeroPreview = (tech) => {
          if(!tech || !tech.Media || !tech.Media.Image) return;
          im.src = tech.Media.Image;
          im.alt = tech.Name || "";
          cap.textContent = tech.Name || "";
        };
        resetHeroPreview = () => {
          im.src = heroDefault.src;
          im.alt = heroDefault.alt;
          cap.textContent = heroDefault.cap;
        };
      }else{
        heroRight.innerHTML = '<div class="empty">No image has been added for this system yet.</div>';
      }

      const inSystem = state.tech
        .filter(t => t.SystemID === systemId)
        .sort((a,b)=>a.Name.localeCompare(b.Name));

      const facts = document.createElement("div");
      facts.className = "cap";
      facts.style.marginTop = "12px";
      facts.textContent = (inSystem.length ? (inSystem.length + " technologies in this system.") : "No technologies in this system yet.");
      heroRight.appendChild(facts);

      if(inSystem.length){
        const chips = document.createElement("div");
        chips.className = "chipRow";

        inSystem.slice(0, 10).forEach(t => {
          const p = document.createElement("span");
          p.className = "pill pillLink";
          p.textContent = t.Name;
          p.addEventListener("click", () => setRoute({ view: "tech", systemId: systemId, techId: t.ID }));
          p.addEventListener("mouseenter", () => { if(setHeroPreview) setHeroPreview(t); });
          p.addEventListener("mouseleave", () => { if(resetHeroPreview) resetHeroPreview(); });
          p.addEventListener("focus", () => { if(setHeroPreview) setHeroPreview(t); });
          p.addEventListener("blur", () => { if(resetHeroPreview) resetHeroPreview(); });
          chips.appendChild(p);
        });

        heroRight.appendChild(chips);
      }

      hero.appendChild(heroLeft);
      hero.appendChild(heroRight);
      left.appendChild(hero);

      const list = state.tech
        .filter(t => t.SystemID === systemId)
        .filter(t => inViewSearch(t.Name + " " + t.Summary + " " + t.Type))
        .sort((a,b)=>a.Name.localeCompare(b.Name));

      if(!list.length){
        right.innerHTML = '<div class="empty">No technologies match your search in this system.</div>';
      }else{
        const grid = document.createElement("div");
        grid.className = "grid";

        list.forEach(t => {
          const c = document.createElement("div");
          c.className = "card";
          c.setAttribute("role", "button");
          c.setAttribute("tabindex", "0");

          const h = document.createElement("h3");
          h.textContent = t.Name;

          const meta = document.createElement("div");
          meta.className = "meta";

          const p1 = document.createElement("span");
          p1.className = "pill teal";
          p1.textContent = t.Type;

          const p2 = document.createElement("span");
          p2.className = "pill";
          p2.textContent = "Tech";

          meta.appendChild(p1);
          meta.appendChild(p2);

          const d = document.createElement("div");
          d.className = "desc";
          d.textContent = t.Summary || "";

          const go = () => setRoute({ view: "tech", systemId: systemId, techId: t.ID });

          c.addEventListener("mouseenter", () => { if(setHeroPreview) setHeroPreview(t); });
          c.addEventListener("mouseleave", () => { if(resetHeroPreview) resetHeroPreview(); });
          c.addEventListener("focus", () => { if(setHeroPreview) setHeroPreview(t); });
          c.addEventListener("blur", () => { if(resetHeroPreview) resetHeroPreview(); });

          c.addEventListener("click", go);
          c.addEventListener("keydown", (ev) => { if(ev.key === "Enter" || ev.key === " ") go(); });

          c.appendChild(h);
          c.appendChild(meta);
          c.appendChild(d);

          grid.appendChild(c);
        });

        
if(list.length){
          const featured = list[0];

          const c2 = document.createElement("div");
          c2.className = "card";
          c2.style.cursor = "default";

          const h2 = document.createElement("h3");
          h2.textContent = "System Snapshot";

          const meta2 = document.createElement("div");
          meta2.className = "meta";

          const q1 = document.createElement("span");
          q1.className = "pill teal";
          q1.textContent = "Overview";

          const q2 = document.createElement("span");
          q2.className = "pill";
          q2.textContent = list.length + " tech";

          meta2.appendChild(q1);
          meta2.appendChild(q2);

          const d2 = document.createElement("div");
          d2.className = "desc";

          const lines = [];
          const sidebar = (sys && sys.SidebarText) ? String(sys.SidebarText).trim() : "";

          if(sidebar){
            d2.textContent = sidebar;
          }else{
            if(sys && sys.Description) lines.push(sys.Description);
            if(featured && featured.Name) lines.push("");
            if(featured && featured.Name) lines.push("Featured: " + featured.Name);

            if(featured && Array.isArray(featured.Constraints) && featured.Constraints.length){
              lines.push("");
              lines.push("Notes:");
              featured.Constraints.slice(0, 3).forEach(x => lines.push("• " + x));
            }else if(featured && featured.Summary){
              lines.push("");
              lines.push(featured.Summary);
            }

            d2.textContent = lines.join("\n");
          }
          c2.appendChild(h2);
          c2.appendChild(meta2);
          c2.appendChild(d2);

          grid.appendChild(c2);

          if(list.length % 2 === 0){
            const spacer = document.createElement("div");
            spacer.className = "card";
            spacer.style.visibility = "hidden";
            spacer.style.cursor = "default";
            spacer.setAttribute("aria-hidden", "true");
            grid.appendChild(spacer);
          }
        }

        right.appendChild(grid);
      }

      split.appendChild(left);
      split.appendChild(right);
      body.appendChild(split);
    }

    function renderTech(techId){
      const body = el("panelBody");
      body.innerHTML = "";

      const t = state.techById.get(techId);
      const sys = state.systemsById.get(t.SystemID);

      const split = document.createElement("div");
      split.className = "split";

      const left = document.createElement("div");
      const right = document.createElement("div");

      const header = document.createElement("div");
      header.className = "section";

      const title = document.createElement("h3");
      title.className = "detailTitle";
      title.textContent = t.Name;

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.style.marginTop = "10px";

      const p1 = document.createElement("span");
      p1.className = "pill teal";
      p1.textContent = t.Type;

      const p2 = document.createElement("span");
      p2.className = "pill";
      p2.textContent = sys ? sys.Name : t.SystemID;

      meta.appendChild(p1);
      meta.appendChild(p2);

      const summary = document.createElement("p");
      summary.className = "detailSummary";
      summary.textContent = t.Summary || "";

      header.appendChild(title);
      header.appendChild(meta);
      header.appendChild(summary);
      left.appendChild(header);

      const sections = t.Sections || {};
      const keys = Object.keys(sections);
      if(keys.length){
        keys.forEach(k => {
          const text = sections[k];
          if(!text) return;
          const sec = document.createElement("div");
          sec.className = "section";
          const h = document.createElement("h4");
          h.textContent = k;
          const p = document.createElement("p");
          p.textContent = text;
          sec.appendChild(h);
          sec.appendChild(p);
          left.appendChild(sec);
        });
      }else{
        const empty = document.createElement("div");
        empty.className = "empty";
        empty.textContent = "No sections have been added for this entry yet.";
        left.appendChild(empty);
      }

      const navCard = document.createElement("div");
      navCard.className = "section";
      const nh = document.createElement("h4");
      nh.textContent = "Navigation";
      const np = document.createElement("p");
      np.textContent = "Use the breadcrumb buttons above, or jump back to the system list from here.";
      navCard.appendChild(nh);
      navCard.appendChild(np);
      right.appendChild(navCard);

      if(t.Media && t.Media.Image){
        const imgCard = document.createElement("div");
        imgCard.className = "section imgCard";
        const ih = document.createElement("h4");
        ih.textContent = "Image";
        const im = document.createElement("img");
        im.src = t.Media.Image;
        im.alt = t.Name;
        const cap = document.createElement("div");
        cap.className = "cap";
        cap.textContent = t.Name;
        imgCard.appendChild(ih);
        imgCard.appendChild(im);
        imgCard.appendChild(cap);
        right.appendChild(imgCard);
      }

      const facts = document.createElement("div");
      facts.className = "section";
      const fh = document.createElement("h4");
      fh.textContent = "At a glance";
      const fp = document.createElement("p");

      const lines = [];
      if(sys) lines.push("System: " + sys.Name);
      lines.push("Type: " + (t.Type || "Entry"));
      if(Array.isArray(t.Operators) && t.Operators.length) lines.push("Operators: " + t.Operators.join(", "));
      if(Array.isArray(t.Meta?.Era) && t.Meta.Era.length) lines.push("Eras: " + t.Meta.Era.join(", "));
      if(Array.isArray(t.Meta?.Affiliations) && t.Meta.Affiliations.length) lines.push("Affiliations: " + t.Meta.Affiliations.join(", "));
      fp.textContent = lines.join("\n");
      facts.appendChild(fh);
      facts.appendChild(fp);

      if(Array.isArray(t.Constraints) && t.Constraints.length){
        const ch = document.createElement("h4");
        ch.style.marginTop = "14px";
        ch.textContent = "Constraints";
        const cp = document.createElement("p");
        cp.textContent = "• " + t.Constraints.slice(0, 4).join("\n• ") + (t.Constraints.length > 4 ? "\n• …" : "");
        facts.appendChild(ch);
        facts.appendChild(cp);
      }

      if(Array.isArray(t.KeyTerms) && t.KeyTerms.length){
        const kh = document.createElement("h4");
        kh.style.marginTop = "14px";
        kh.textContent = "Key terms";
        const kp = document.createElement("p");
        const kt = t.KeyTerms.slice(0, 4).map(x => (x.Term ? (x.Term + ": " + (x.Definition || "")) : "")).filter(Boolean);
        kp.textContent = kt.join("\n\n") + (t.KeyTerms.length > 4 ? "\n\n…" : "");
        facts.appendChild(kh);
        facts.appendChild(kp);
      }

      right.appendChild(facts);

      if(Array.isArray(t.Appearances) && t.Appearances.length){
        const app = document.createElement("div");
        app.className = "section";
        const ah = document.createElement("h4");
        ah.textContent = "Appearances";
        const ap = document.createElement("p");

        const maxShow = 7;
        const first = t.Appearances.slice(0, maxShow);
        ap.textContent = first.map(a => {
          const label = [a.Series, a.Title].filter(Boolean).join(" • ");
          if(a.Season != null && a.Episode != null && a.Series && a.Series !== "Film") return a.Series + " S" + a.Season + "E" + a.Episode + " • " + a.Title;
          return label || "";
        }).filter(Boolean).join("\n") + (t.Appearances.length > maxShow ? "\n…(" + (t.Appearances.length - maxShow) + " more)" : "");
        app.appendChild(ah);
        app.appendChild(ap);

        if(t.Appearances.length > maxShow){
          const hidden = document.createElement("div");
          hidden.style.display = "none";
          const hp = document.createElement("p");
          hp.textContent = t.Appearances.slice(maxShow).map(a => {
            const label = [a.Series, a.Title].filter(Boolean).join(" • ");
            if(a.Season != null && a.Episode != null && a.Series && a.Series !== "Film") return a.Series + " S" + a.Season + "E" + a.Episode + " • " + a.Title;
            return label || "";
          }).filter(Boolean).join("\n");
          hidden.appendChild(hp);

          const btn = document.createElement("button");
          btn.className = "miniBtn";
          btn.textContent = "Show all";
          btn.addEventListener("click", () => {
            const open = hidden.style.display !== "none";
            hidden.style.display = open ? "none" : "block";
            btn.textContent = open ? "Show all" : "Show less";
          });

          app.appendChild(btn);
          app.appendChild(hidden);
        }

        right.appendChild(app);
      }

      const row = document.createElement("div");

      row.style.display = "flex";
      row.style.gap = "10px";
      row.style.flexWrap = "wrap";
      row.style.marginTop = "12px";

      const back1 = document.createElement("button");
      back1.className = "btn";
      back1.textContent = "Back to System";
      back1.addEventListener("click", () => setRoute({ view: "system", systemId: t.SystemID }));

      const back2 = document.createElement("button");
      back2.className = "btn";
      back2.textContent = "Back to Systems";
      back2.addEventListener("click", () => setRoute({ view: "systems" }));

      row.appendChild(back1);
      row.appendChild(back2);
      right.appendChild(row);

      split.appendChild(left);
      split.appendChild(right);
      body.appendChild(split);
    }

    init();
  </script>
</body>
</html>
